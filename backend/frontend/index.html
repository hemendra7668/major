<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Patient Vital Prediction â€” Robo-Doc (With Voice, Pulse & Warnings)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ===== Global futuristic theme (same style) ===== */
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: "Inter", "Poppins", system-ui, sans-serif;
      background: radial-gradient(circle at 10% 10%, #081229 0%, #071a2b 15%, #072833 45%, #0b3a4a 100%);
      color:#e6f7ff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    .page { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:36px; flex-direction:column; gap:20px; }

    .panel { width:100%; max-width:1100px; display:grid; grid-template-columns: 440px 1fr; gap:22px; align-items:start; }
    @media (max-width:980px){ .panel { grid-template-columns: 1fr; padding: 0 16px; } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius:18px; padding:18px; box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.03);
      backdrop-filter: blur(10px); border: 1px solid rgba(64, 220, 255, 0.06); }

    h1 { margin:0 0 6px 0; font-size:1.45rem;
      background:linear-gradient(90deg,#7efcff,#63ff9b); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      letter-spacing:0.3px; }
    p.lead { color: #9feefd; margin:6px 0 18px 0; font-size:0.95rem; }

    label { display:block; margin-top:10px; color:#cfeff4; font-size:0.9rem; }
    input, textarea { width:100%; padding:10px 12px; border-radius:10px; border:none; outline:none;
      background: rgba(255,255,255,0.035); color:#eafcff; font-size:0.95rem; }
    textarea { resize: vertical; min-height:88px; font-family: monospace; }

    .btn { display:inline-block; margin-top:12px; width:100%; padding:11px 14px; border-radius:12px;
      background: linear-gradient(90deg,#00f0ff,#7dffb5); color:#021117; font-weight:700; border:none;
      cursor:pointer; transition:transform .18s ease, box-shadow .18s ease; box-shadow: 0 6px 20px rgba(0,230,255,0.08); }
    .btn:active { transform: translateY(2px) scale(.998); }
    .btn.ghost { background:transparent; color:#9feefd; border:1px solid rgba(100,230,255,0.08); box-shadow:none; }

    .result { margin-top:12px; padding:12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(0,255,255,0.06); color:#eafffb; font-size:0.95rem; }

    /* Robot column */
    .robot-area { display:flex; flex-direction:column; gap:14px; align-items:center; justify-content:flex-start; }
    .robot-card { width:100%; display:flex; gap:12px; align-items:center; padding:18px; border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(0,255,255,0.04); position:relative; overflow:visible; }
    .robot { width:170px; height:170px; display:flex; align-items:center; justify-content:center; padding:8px; margin-right:6px; }
    .robot-info { flex:1; }
    .robot-title { font-weight:700; color:#c8ffff; margin-bottom:6px; }
    .robot-sub { color:#9feefd; font-size:0.9rem; margin-bottom:6px; }
    .status { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
      background: rgba(0,255,220,0.04); color:#bffcf4; border:1px solid rgba(0,255,220,0.06); font-weight:600; font-size:0.85rem; }

    /* Warning badge */
    .warning-badge {
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background: rgba(255,90,90,0.12); color:#ffd7d7; border:1px solid rgba(255,90,90,0.18); font-weight:700;
      box-shadow: 0 6px 16px rgba(255,0,0,0.06);
    }
    .warning-icon {
      width:18px; height:18px; display:inline-block; background:transparent; position:relative;
    }
    .warning-icon:before{
      content: "â–²"; transform: translateY(-1px); color:#ff4d4d; font-size:14px;
    }

    /* SVG animations */
    svg.robot-svg { width:160px; height:160px; display:block; }
    .eye { filter: drop-shadow(0 0 6px rgba(0,240,255,0.55)); transition: transform .25s ease; }
    .eye.glow { animation: eyePulse 1.2s infinite; transform-origin:center; }
    @keyframes eyePulse { 0% { transform: scale(1); opacity:1 } 50% { transform: scale(1.15); opacity:0.85 } 100% { transform: scale(1); opacity:1 } }

    .head { transform-origin: 50% 45%; transition: transform .5s cubic-bezier(.2,.9,.3,1); }
    .head.tilt { transform: rotate(-6deg); }
    .arm { transform-origin: 14px 28px; transition: transform .45s cubic-bezier(.2,.9,.3,1); }
    .arm.wave { transform: rotate(-18deg); }
    .stetho { transition: transform .25s ease; }
    .stetho.pulse { transform: scale(1.04); }
    .halo { opacity:0; transform: scale(.9); transition: all .35s ease; }
    .halo.on { opacity:1; transform: scale(1); filter: blur(6px); }
    .glow-ring { stroke: rgba(0,240,255,0.12); stroke-width:12; stroke-linecap:round; animation: ringPulse 1.8s infinite; }
    @keyframes ringPulse { 0% { opacity:0.3 } 50% { opacity:0.7 } 100% { opacity:0.3 } }

    .hint { font-size:0.85rem; color:#9feefd; margin-top:6px; text-align:center; }

    /* Heartbeat canvas area */
    .pulse-wrap { margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .pulse-canvas { background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:10px; padding:10px; border:1px solid rgba(0,255,255,0.04); }
    #pulseCanvas { width:260px; height:80px; display:block; }
    .bpm-display { text-align:center; color:#9feefd; font-weight:700; font-size:1.2rem; }

    /* responsive */
    @media (max-width:600px){ #pulseCanvas { width:200px; height:64px } }

  </style>
</head>
<body>
  <div class="page">
    <div class="panel">
      <!-- LEFT: Robot column -->
      <div class="card robot-area">
        <div class="robot-card">
          <div class="robot" aria-hidden="true">
            <!-- Inline SVG Robot Doctor -->
            <svg class="robot-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Robot doctor">
              <g class="halo" transform="translate(100 30)">
                <ellipse cx="0" cy="0" rx="52" ry="18" fill="none" class="glow-ring"></ellipse>
              </g>
              <g transform="translate(20,14)" class="robot-body">
                <rect x="40" y="56" rx="18" ry="18" width="100" height="84" fill="url(#grad1)" stroke="rgba(255,255,255,0.06)"></rect>
                <g class="head" transform="translate(40,2)">
                  <rect x="10" y="10" rx="12" ry="12" width="80" height="58" fill="#081a24" stroke="rgba(0,255,255,0.08)"></rect>
                  <g transform="translate(28,28)">
                    <circle cx="8" cy="6" r="6" fill="#cfffff" class="eye" id="eye-left"/>
                    <circle cx="36" cy="6" r="6" fill="#cfffff" class="eye" id="eye-right"/>
                    <circle cx="8" cy="6" r="2.5" fill="#002533"/>
                    <circle cx="36" cy="6" r="2.5" fill="#002533"/>
                  </g>
                  <rect x="20" y="46" width="56" height="6" rx="3" fill="rgba(0,255,255,0.06)"></rect>
                </g>
                <g class="arm" transform="translate(8,70)"><rect x="0" y="0" width="18" height="10" rx="3" fill="#0b2b37" /><rect x="-6" y="10" rx="5" ry="5" width="30" height="12" fill="#07333b" /></g>
                <g class="arm" id="right-arm" transform="translate(132,66)">
                  <rect x="0" y="0" width="18" height="10" rx="3" fill="#0b2b37" />
                  <rect x="0" y="10" rx="5" ry="5" width="30" height="12" fill="#07333b" />
                  <g transform="translate(34,12)" class="stetho">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="#00f0ff" stroke-width="2" opacity="0.18"></circle>
                    <circle cx="12" cy="12" r="5" fill="#00f0ff" opacity="0.14"></circle>
                  </g>
                </g>
                <g transform="translate(72,86)"><rect x="-8" y="-10" width="40" height="28" rx="6" fill="#021617" stroke="rgba(0,255,255,0.06)"></rect><text x="12" y="10" font-size="9" fill="#8ff5ff" text-anchor="middle" font-family="sans-serif">DR-01</text></g>
                <defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#073a46" stop-opacity="1" /><stop offset="100%" stop-color="#00202a" stop-opacity="1" /></linearGradient></defs>
              </g>
            </svg>
          </div>

          <div class="robot-info">
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="robot-title">Robo-Doc 2.1</div>
              <!-- Warning badge placeholder -->
              <div id="robotWarning" style="display:none;"></div>
            </div>
            <div class="robot-sub">Clinical assistant â€” analyzes recent vitals</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div id="robot-status" class="status">Ready</div>
              <div style="flex:1"></div>
              <!-- Voice toggle -->
              <button id="voiceToggle" class="btn ghost" style="width:auto;padding:8px 10px;font-size:0.85rem">ðŸ”Š Voice: On</button>
            </div>
          </div>
        </div>

        <div class="hint">Robot animates while computing â€” shows a single prediction for your uploaded window.</div>

        <!-- heartbeat / pulse -->
        <div class="pulse-wrap" style="width:100%;align-items:center;">
          <div class="pulse-canvas">
            <canvas id="pulseCanvas" width="260" height="80" style="display:block"></canvas>
          </div>
          <div style="min-width:90px;text-align:center;">
            <div style="font-size:0.8rem;color:#9feefd">Estimated BPM</div>
            <div class="bpm-display" id="bpmDisplay">â€”</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; width:100%;">
          <button class="btn ghost" onclick="waveRobot()">Wave</button>
          <button class="btn" onclick="flashStatus()">Ping</button>
        </div>
      </div>

      <!-- RIGHT: Input / prediction column -->
      <div class="card">
        <h1>Patient Vital Prediction</h1>
        <p class="lead">Provide either a single input or upload 7â€“10 recent rows (CSV / JSON array). The Robo-Doc will analyze the window and give one combined prediction.</p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label>Age</label><input id="Age" value="45">
          </div>
          <div>
            <label>Gender (0=Male,1=Female)</label><input id="Gender" value="0">
          </div>
        </div>

        <label>BMI</label><input id="BMI" value="24.5">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div><label>Derived_HRV</label><input id="Derived_HRV" value="5.1"></div>
          <div><label>Derived_Pulse_Pressure</label><input id="Derived_Pulse_Pressure" value="40"></div>
        </div>
        <label>Derived_MAP</label><input id="Derived_MAP" value="90">

        <button class="btn" style="margin-top:14px" onclick="predictSingle()">Predict (single)</button>

        <hr style="margin:18px 0; opacity:0.06">

        <label>Upload CSV (7â€“10 rows)</label>
        <input type="file" id="fileInput" accept=".csv">
        <small style="display:block;margin-top:6px;color:#9feefd">Or paste JSON array below (e.g. [{"Age":45,"Gender":0,"BMI":24.5,"Derived_HRV":5,...}, {...}] )</small>
        <textarea id="jsonArea" placeholder='[{"Age":45,"Gender":0,"BMI":24.5,"Derived_HRV":5,...}, {...}]'></textarea>
        <button class="btn" onclick="predictWindow()">Predict (window)</button>

        <!-- note: prediction output has been moved to a separate full-width card below -->
      </div>
    </div>

    <!-- NEW: Full-width Prediction Card (separate from input) -->
    <div id="predictionCard" class="card" style="display:none; max-width:1100px; width:100%;">
      <h2 style="margin:0 0 6px 0; color:#bffcf4">Prediction Result</h2>
      <div id="predictionOutput" class="result"></div>
    </div>
  </div>

  <script>
    // -----------------------
    // DOM refs & animation helpers
    // -----------------------
    const robotStatus = document.getElementById('robot-status');
    const eyeLeft = document.getElementById('eye-left');
    const eyeRight = document.getElementById('eye-right');
    const head = document.querySelector('.head');
    const rightArm = document.getElementById('right-arm');
    const halo = document.querySelector('.halo');
    const stetho = document.querySelector('.stetho');
    const voiceToggle = document.getElementById('voiceToggle');
    const bpmDisplay = document.getElementById('bpmDisplay');
    const robotWarning = document.getElementById('robotWarning');

    // NEW: prediction card reference
    const predictionCard = document.getElementById('predictionCard');
    const predictionOutput = document.getElementById('predictionOutput');

    let voiceEnabled = true;
    voiceToggle.addEventListener('click', () => {
      voiceEnabled = !voiceEnabled;
      voiceToggle.textContent = voiceEnabled ? 'ðŸ”Š Voice: On' : 'ðŸ”‡ Voice: Off';
    });

    function setStatus(text){
      robotStatus.textContent = text;
    }

    function setWarning(on, messages){
      if(on){
        robotWarning.innerHTML = `<div class="warning-badge"><div class="warning-icon"></div><div>Warning</div></div>`;
        // visually change status to warning style
        robotStatus.style.background = 'rgba(255,90,90,0.12)';
        robotStatus.style.color = '#ffdcdc';
        robotStatus.style.borderColor = 'rgba(255,90,90,0.18)';
      } else {
        robotWarning.innerHTML = '';
        robotStatus.style.background = '';
        robotStatus.style.color = '';
        robotStatus.style.borderColor = '';
      }
    }

    function animateRobotDuring(fn){
      eyeLeft.classList.add('glow'); eyeRight.classList.add('glow');
      head.classList.add('tilt'); rightArm.classList.add('wave');
      halo.classList.add('on'); stetho.classList.add('pulse');
      setStatus('Analyzing...');
      // clear previous warnings visually while analyzing
      setWarning(false);
      return Promise.resolve().then(fn).finally(() => {
        setTimeout(()=> {
          eyeLeft.classList.remove('glow'); eyeRight.classList.remove('glow');
          head.classList.remove('tilt'); rightArm.classList.remove('wave');
          halo.classList.remove('on'); stetho.classList.remove('pulse');
          // don't override Warning state here â€” warning will be set in handlePredictionResponse if needed
          if(!robotWarning.innerHTML) setStatus('Ready');
        }, 700);
      });
    }

    function waveRobot(){ rightArm.classList.add('wave'); setTimeout(()=> rightArm.classList.remove('wave'), 700); }
    function flashStatus(){ setStatus('Checking...'); setTimeout(()=> setStatus('Ready'), 900); }

    // -----------------------
    // Pulse/Heartbeat animation (canvas)
    // -----------------------
    const canvas = document.getElementById('pulseCanvas');
    const ctx = canvas.getContext('2d');
    let canvasW = canvas.width, canvasH = canvas.height;
    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      canvasW = Math.max(200, Math.floor(rect.width));
      canvasH = Math.max(60, Math.floor(rect.height));
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvasW * dpr;
      canvas.height = canvasH * dpr;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    let lastTimestamp = null;
    let phase = 0;
    let targetBPM = 72;
    let amplitude = 0.9;
    let running = true;
    function bpmToFreq(bpm){ return Math.max(0.4, bpm/60); }
    function waveform(t, freq){
      const period = 1 / freq;
      const phaseInPeriod = t % period;
      const spikeWidth = Math.min(0.12, 0.12);
      const spike = Math.exp(-((phaseInPeriod)/(spikeWidth)) * 5) * 1.2;
      const baseline = Math.sin(2*Math.PI*freq*t*2) * 0.12;
      return spike + baseline;
    }
    function drawFrame(ts){
      if(!lastTimestamp) lastTimestamp = ts;
      const dt = (ts - lastTimestamp)/1000;
      lastTimestamp = ts;
      phase += dt;
      const freq = bpmToFreq(targetBPM);
      ctx.clearRect(0,0,canvasW,canvasH);
      ctx.beginPath();
      const samples = 240;
      for(let i=0;i<=samples;i++){
        const x = (i/samples) * canvasW;
        const t = phase + (i/samples) * 1.0;
        const yval = waveform(t, freq) * amplitude;
        const y = canvasH*0.6 - yval*(canvasH*0.42);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = 'rgba(0,240,255,0.95)';
      ctx.lineWidth = 2.4;
      ctx.stroke();
      ctx.beginPath();
      for(let i=0;i<=samples;i++){
        const x = (i/samples) * canvasW;
        const t = phase + (i/samples) * 1.0;
        const yval = waveform(t, freq) * amplitude;
        const y = canvasH*0.6 - yval*(canvasH*0.42);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = 'rgba(0,240,255,0.14)';
      ctx.lineWidth = 10;
      ctx.stroke();
      if(running) requestAnimationFrame(drawFrame);
    }
    requestAnimationFrame(drawFrame);
    function setBPM(bpm){
      targetBPM = Math.max(30, Math.min(180, Math.round(bpm)));
      amplitude = 0.9 + Math.min(1.6, (targetBPM-60)/60);
      bpmDisplay.textContent = targetBPM + ' bpm';
    }

    // -----------------------
    // Thresholds (India-oriented normal ranges)
    // -----------------------
    const NORMAL_RANGES = {
      "Heart Rate": { min: 60, max: 100, label: "Pulse (bpm)" },
      "Respiratory Rate": { min: 12, max: 20, label: "Breaths/min" },
      "Body Temperature": { min: 36.1, max: 37.2, label: "Temperature (Â°C)" },
      "Oxygen Saturation": { min: 94, max: 100, label: "SpOâ‚‚ (%)" },
      "Systolic Blood Pressure": { min: 90, max: 120, label: "Systolic BP (mmHg)" },
      "Diastolic Blood Pressure": { min: 60, max: 80, label: "Diastolic BP (mmHg)" }
    };

    // returns list of warning messages for out-of-range values
    function checkWarnings(predictions){
      const warnings = [];
      for(const [k,v] of Object.entries(predictions)){
        if(NORMAL_RANGES[k]){
          const {min, max, label} = NORMAL_RANGES[k];
          const val = Number(v);
          if(Number.isFinite(val) && (val < min || val > max)){
            const direction = val < min ? "low" : "high";
            warnings.push({ key: k, label, value: val, direction, normal: `${min}â€“${max}` });
          }
        }
      }
      return warnings;
    }

    // -----------------------
    // API and Prediction logic
    // -----------------------
    async function predictSingle(){
      const features = ["Age","Gender","BMI","Derived_HRV","Derived_Pulse_Pressure","Derived_MAP"];
      const payload = {};
      features.forEach(f => payload[f] = parseFloat(document.getElementById(f).value || 0));
      await animateRobotDuring(async () => {
        try {
          const res = await fetch('/predict', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          const j = await res.json();
          handlePredictionResponse(j);
        } catch(err){
          handlePredictionResponse({success:false, error:err.toString()});
        }
      });
    }

    async function predictWindow(){
      const fileEl = document.getElementById('fileInput');
      const jsonText = document.getElementById('jsonArea').value.trim();
      if(fileEl.files && fileEl.files.length > 0){
        const fd = new FormData(); fd.append('file', fileEl.files[0]);
        await animateRobotDuring(async () => {
          try {
            const res = await fetch('/predict_window', { method:'POST', body: fd });
            const j = await res.json();
            handlePredictionResponse(j);
          } catch(err){
            handlePredictionResponse({success:false, error:err.toString()});
          }
        });
        return;
      }
      if(jsonText){
        let parsed;
        try { parsed = JSON.parse(jsonText); } catch(e){ handlePredictionResponse({success:false, error:'Invalid JSON: '+e}); return; }
        const body = Array.isArray(parsed) ? parsed : { rows: parsed };
        await animateRobotDuring(async () => {
          try {
            const res = await fetch('/predict_window', {
              method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
            });
            const j = await res.json();
            handlePredictionResponse(j);
          } catch(err){
            handlePredictionResponse({success:false, error:err.toString()});
          }
        });
        return;
      }
      handlePredictionResponse({success:false, error:'Please upload a CSV or paste JSON array'});
    }

    function handlePredictionResponse(resp){
      // show the prediction in the separate card
      if(!resp){ predictionOutput.innerHTML = '<b>Error:</b> empty response'; showPredictionCard(); return; }
      if(resp.success){
        let html = '<h3 style="margin:0 0 8px 0;color:#cfffff">Predicted Vitals</h3>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">';
        for(const [k,v] of Object.entries(resp.predictions)){
          html += `<div style="padding:8px;border-radius:8px;background:rgba(0,255,255,0.02);border:1px solid rgba(0,255,255,0.04)"><strong>${k}</strong><div style="font-size:1.2rem;margin-top:6px">${v}</div></div>`;
        }
        html += '</div>';
        if(resp.meta && resp.meta.representative_features){
          html += '<hr style="opacity:0.06;margin:12px 0">';
          html += '<div style="font-size:0.9rem;color:#bffcf4"><strong>Representative features used:</strong><pre style="white-space:pre-wrap;margin:8px 0 0 0;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px;">' + JSON.stringify(resp.meta.representative_features, null, 2) + '</pre></div>';
          html += `<div style="margin-top:8px;color:#9feefd"><em>Rows used:</em> ${resp.meta.rows_used}</div>`;
        }
        predictionOutput.innerHTML = html;
        const hr = parseFloat(resp.predictions["Heart Rate"]) || targetBPM;
        setBPM(Math.round(hr));
        // check warnings
        const warnings = checkWarnings(resp.predictions);
        if(warnings.length){
          // show warning badge and speak urgent message
          setWarning(true, warnings);
          // set status text to Warning
          setStatus('Warning');
          // speak urgent summary
          roboSpeakWarning(warnings);
          // small robot visual cue: make eyes pulse faster briefly
          eyeLeft.classList.add('glow'); eyeRight.classList.add('glow');
        } else {
          setWarning(false);
          roboSpeakSummary(resp);
          setStatus('Done âœ“');
        }
        robotStatus.textContent = robotStatus.textContent; // keep style changes
      } else {
        predictionOutput.innerHTML = `<div style="color:#ffd1d1"><strong>Error:</strong> ${resp.error || JSON.stringify(resp)}</div>`;
        robotStatus.textContent = 'Error';
        setWarning(false);
      }
      showPredictionCard();
    }

    function showPredictionCard(){
      predictionCard.style.display = 'block';
      predictionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // -----------------------
    // Text-to-speech for Robo-Doc summary
    // -----------------------
    function roboSpeakSummary(resp){
      if(!voiceEnabled) return;
      try {
        const preds = resp.predictions;
        const hr = Math.round(preds["Heart Rate"]*10)/10;
        const rr = Math.round(preds["Respiratory Rate"]*10)/10;
        const temp = Math.round(preds["Body Temperature"]*10)/10;
        const spo2 = Math.round(preds["Oxygen Saturation"]*10)/10;
        const sbp = Math.round(preds["Systolic Blood Pressure"]*10)/10;
        const dbp = Math.round(preds["Diastolic Blood Pressure"]*10)/10;
        const sentence = `Prediction ready. Heart rate ${hr} beats per minute. Respiratory rate ${rr}. Temperature ${temp} degrees Celsius. Oxygen saturation ${spo2} percent. Blood pressure ${sbp} over ${dbp}.`;
        if('speechSynthesis' in window){
          const u = new SpeechSynthesisUtterance(sentence);
          u.rate = 0.95; u.pitch = 0.9;
          const voices = speechSynthesis.getVoices();
          if(voices && voices.length){
            const v = voices.find(v=>/en|English/i.test(v.lang)) || voices[0];
            if(v) u.voice = v;
          }
          speechSynthesis.cancel();
          speechSynthesis.speak(u);
        }
      } catch(e){
        console.warn("TTS failed", e);
      }
    }

    // urgent warning speech (shorter, higher urgency)
    function roboSpeakWarning(warnings){
      if(!voiceEnabled) return;
      try {
        const parts = warnings.map(w => `${w.label} is ${w.direction} (${w.value}).`);
        const sentence = `Warning. Abnormal vitals detected. ${parts.join(' ') } Please review.`;
        if('speechSynthesis' in window){
          const u = new SpeechSynthesisUtterance(sentence);
          u.rate = 0.98; u.pitch = 0.7; // slightly lower pitch for urgency
          const voices = speechSynthesis.getVoices();
          if(voices && voices.length){
            const v = voices.find(v=>/en|English/i.test(v.lang)) || voices[0];
            if(v) u.voice = v;
          }
          speechSynthesis.cancel();
          // repeat warning twice for emphasis
          speechSynthesis.speak(u);
          setTimeout(()=> speechSynthesis.speak(u), 900);
        }
      } catch(e){
        console.warn("TTS failed", e);
      }
    }

    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = function(){ /* no-op */ };
    }

    // -----------------------
    // Initialize defaults
    // -----------------------
    setBPM(72);
    setStatus('Ready');

  </script>
</body>
</html>
